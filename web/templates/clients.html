{% extends "base.html" %}
{% block title %}Клиенты{% endblock %}

{% block content %}
{% set role = request.state.role|default('admin') %}
<h2 class="mb-4"><i class="bi bi-people"></i> Клиенты</h2>

{% if flash_msg %}
<div class="alert alert-{{ flash_type }} alert-dismissible fade show mb-4" role="alert">
    {{ flash_msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Filters -->
<div class="row mb-3 g-2">
    <div class="col-auto">
        <input type="text" id="filterName" class="form-control" placeholder="Поиск по имени..." style="width: 220px;">
    </div>
    <div class="col-auto">
        <input type="text" id="filterPhone" class="form-control" placeholder="Поиск по телефону..." style="width: 220px;">
    </div>
</div>

{% if clients %}
<div class="table-responsive">
    <table class="table table-hover align-middle" id="clientsTable">
        <thead class="table-light">
            <tr>
                <th>Telegram ID</th>
                <th>Имя</th>
                <th>Username</th>
                <th>Телефон</th>
                <th>Бонусов</th>
                <th>Дата регистрации</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr data-name="{{ (client.first_name or '')|lower }} {{ (client.last_name or '')|lower }}" data-phone="{{ client.phone or '' }}">
                <td><code>{{ client.telegram_id }}</code></td>
                <td>{{ client.first_name or '—' }} {{ client.last_name or '' }}</td>
                <td>{% if client.username %}@{{ client.username }}{% else %}—{% endif %}</td>
                <td>{{ client.phone or '—' }}</td>
                <td><span class="badge bg-primary">{{ client.bonus_total }}</span></td>
                <td>{{ client.created_at|tomsk }}</td>
                <td class="text-nowrap">
                    <!-- Settings -->
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal{{ client.id }}" title="Настройки клиента">
                        <i class="bi bi-gear"></i>
                    </button>
                    <!-- Send message -->
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#msgModal{{ client.id }}" title="Отправить сообщение">
                        <i class="bi bi-envelope"></i>
                    </button>
                    {% if role == 'admin' %}
                    <!-- Delete -->
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#delModal{{ client.id }}" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}

                    <!-- Settings modal -->
                    <div class="modal fade" id="settingsModal{{ client.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form action="{{ B }}/admin/clients/{{ client.id }}/update" method="post">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Настройки — {{ client.first_name or client.telegram_id }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Имя</label>
                                            <input type="text" name="first_name" class="form-control" value="{{ client.first_name or '' }}" placeholder="Имя клиента">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Телефон</label>
                                            <input type="tel" name="phone" class="form-control phone-mask" value="{{ client.phone or '' }}" placeholder="+7 ___ ___ __ __">
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                        <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Сохранить</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Message modal -->
                    <div class="modal fade" id="msgModal{{ client.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form action="{{ B }}/admin/clients/{{ client.id }}/message" method="post">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Сообщение для {{ client.first_name or client.telegram_id }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <textarea name="message_text" class="form-control" rows="4" placeholder="Текст сообщения..." required></textarea>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                        <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i> Отправить</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    {% if role == 'admin' %}
                    <!-- Delete confirm modal -->
                    <div class="modal fade" id="delModal{{ client.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Удалить клиента?</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    Вы уверены, что хотите удалить клиента <b>{{ client.first_name or '' }} {{ client.last_name or '' }}</b>?
                                    Все его бонусы и сообщения тоже будут удалены.
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                    <form action="{{ B }}/admin/clients/{{ client.id }}/delete" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-danger"><i class="bi bi-trash"></i> Удалить</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<nav>
    <ul class="pagination" id="pagination"></ul>
</nav>
<p class="text-muted">Всего клиентов: {{ clients|length }}</p>

{% else %}
<div class="alert alert-info">Клиентов пока нет. Они появятся после первого запуска бота.</div>
{% endif %}

<script>
(function() {
    var PER_PAGE = 15;
    var currentPage = 1;
    var rows = Array.from(document.querySelectorAll('#clientsTable tbody tr'));
    var filtered = rows.slice();
    var paginationEl = document.getElementById('pagination');
    var nameInput = document.getElementById('filterName');
    var phoneInput = document.getElementById('filterPhone');

    function applyFilters() {
        var nameQ = (nameInput.value || '').toLowerCase();
        var phoneQ = (phoneInput.value || '').replace(/\D/g, '');
        filtered = rows.filter(function(row) {
            var name = row.getAttribute('data-name') || '';
            var phone = (row.getAttribute('data-phone') || '').replace(/\D/g, '');
            var nameOk = !nameQ || name.includes(nameQ);
            var phoneOk = !phoneQ || phone.includes(phoneQ);
            return nameOk && phoneOk;
        });
        currentPage = 1;
        render();
    }

    function render() {
        var totalPages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
        if (currentPage > totalPages) currentPage = totalPages;
        var start = (currentPage - 1) * PER_PAGE;
        var end = start + PER_PAGE;
        var visible = filtered.slice(start, end);

        rows.forEach(function(r) { r.style.display = 'none'; });
        visible.forEach(function(r) { r.style.display = ''; });

        // Pagination
        var html = '';
        if (totalPages > 1) {
            html += '<li class="page-item ' + (currentPage === 1 ? 'disabled' : '') + '"><a class="page-link" href="#" data-p="' + (currentPage - 1) + '">&laquo;</a></li>';
            for (var i = 1; i <= totalPages; i++) {
                html += '<li class="page-item ' + (i === currentPage ? 'active' : '') + '"><a class="page-link" href="#" data-p="' + i + '">' + i + '</a></li>';
            }
            html += '<li class="page-item ' + (currentPage === totalPages ? 'disabled' : '') + '"><a class="page-link" href="#" data-p="' + (currentPage + 1) + '">&raquo;</a></li>';
        }
        paginationEl.innerHTML = html;
    }

    paginationEl.addEventListener('click', function(e) {
        e.preventDefault();
        var p = e.target.getAttribute('data-p');
        if (p) { currentPage = parseInt(p); render(); }
    });

    nameInput.addEventListener('input', applyFilters);
    phoneInput.addEventListener('input', applyFilters);

    render();
})();
</script>
{% endblock %}
