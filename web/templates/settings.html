{% extends "base.html" %}
{% block title %}Настройки{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-gear"></i> Настройки</h2>

{% if flash_msg %}
<div class="alert alert-{{ flash_type }} alert-dismissible fade show mb-4" role="alert">
    {{ flash_msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Default bonus settings (collapsed) -->
<div class="card mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center" role="button" data-bs-toggle="collapse" data-bs-target="#defaultSettings">
        <h5 class="mb-0"><i class="bi bi-gift"></i> Бонусы по умолчанию для новых клиентов</h5>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse" id="defaultSettings">
        <div class="card-body">
            <form action="{{ B }}/admin/bonuses/default-settings" method="post" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label class="form-label">Количество</label>
                    <input type="number" name="default_amount" class="form-control" min="0" value="{{ default_amount }}" required style="width: 120px;">
                </div>
                <div class="col-auto pt-2">
                    <div class="form-check form-switch">
                        <input type="checkbox" name="default_enabled" value="1" class="form-check-input" id="defaultEnabled" {% if default_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="defaultEnabled">Включено</label>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-check-lg"></i> Сохранить
                    </button>
                </div>
            </form>
            <small class="text-muted mt-2 d-block">Каждый новый клиент автоматически получит бонусы с уникальным промокодом при первом запуске бота</small>
        </div>
    </div>
</div>

<!-- Batch assign (collapsed) -->
<div class="card mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center" role="button" data-bs-toggle="collapse" data-bs-target="#batchAssign">
        <h5 class="mb-0"><i class="bi bi-people"></i> Начислить бонусы всем клиентам</h5>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse" id="batchAssign">
        <div class="card-body">
            <form action="{{ B }}/admin/bonuses/assign-all" method="post" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label class="form-label">Количество</label>
                    <input type="number" name="amount" class="form-control" min="1" required style="width: 120px;">
                </div>
                <div class="col-auto">
                    <label class="form-label">Промокод (или авто)</label>
                    <input type="text" name="promo_code" class="form-control" placeholder="BONUS-XXXXXX" style="width: 200px;">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-send"></i> Начислить всем
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign to specific client (collapsed) -->
<div class="card mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center" role="button" data-bs-toggle="collapse" data-bs-target="#clientAssign">
        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Начислить бонусы клиенту</h5>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse" id="clientAssign">
        <div class="card-body">
            <form action="" method="post" id="assignForm" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label class="form-label">Клиент</label>
                    <select name="client_id" class="form-select" id="clientSelect" required style="width: 250px;">
                        <option value="">Выберите клиента</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}">
                            {{ client.first_name or '' }} {{ client.last_name or '' }}
                            {% if client.username %}(@{{ client.username }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label">Количество</label>
                    <input type="number" name="amount" class="form-control" min="1" required style="width: 120px;">
                </div>
                <div class="col-auto">
                    <label class="form-label">Промокод (или авто)</label>
                    <input type="text" name="promo_code" class="form-control" placeholder="BONUS-XXXXXX" style="width: 200px;">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Начислить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('clientSelect').addEventListener('change', function() {
    var form = document.getElementById('assignForm');
    form.action = '{{ B }}/admin/bonuses/assign/' + this.value;
});
document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(el) {
    var target = document.querySelector(el.getAttribute('data-bs-target'));
    target.addEventListener('show.bs.collapse', function() {
        var icon = el.querySelector('.bi-chevron-down');
        if (icon) icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
    });
    target.addEventListener('hide.bs.collapse', function() {
        var icon = el.querySelector('.bi-chevron-up');
        if (icon) icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
    });
});
</script>

<!-- Welcome text -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Приветственный текст</h5>
    </div>
    <div class="card-body">
        <form action="{{ B }}/admin/settings/welcome-text" method="post">
            <div class="mb-3">
                <label class="form-label">Текст при запуске бота (/start)</label>
                <textarea name="welcome_text" class="form-control" rows="4" placeholder="Добро пожаловать в наш магазин!">{{ welcome_text }}</textarea>
            </div>
            <small class="text-muted d-block mb-3">Если оставить пустым, будет использоваться текст по умолчанию</small>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Сохранить
            </button>
        </form>
    </div>
</div>

<!-- Bonus terms -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-book"></i> Условия бонусной программы</h5>
    </div>
    <div class="card-body">
        <form action="{{ B }}/admin/settings/bonus-terms" method="post">
            <div class="mb-3">
                <label class="form-label">Текст при нажатии кнопки "Условия бонусной программы"</label>
                <textarea name="bonus_terms" class="form-control" rows="6" placeholder="Условия бонусной программы...">{{ bonus_terms }}</textarea>
            </div>
            <small class="text-muted d-block mb-3">Если оставить пустым, будет показано "Условия будут тут позже"</small>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Сохранить
            </button>
        </form>
    </div>
</div>
{% endblock %}
