{% extends "base.html" %}
{% block title %}{% if mailing %}Редактировать{% else %}Создать{% endif %} рассылку{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ B }}/admin/mailings" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Назад
    </a>
</div>

<h2 class="mb-4">{% if mailing %}Редактировать{% else %}Создать{% endif %} рассылку</h2>

<div class="card p-4" style="max-width: 700px;">
    <form action="{{ B }}/admin/mailings/{% if mailing %}{{ mailing.id }}/edit{% else %}create{% endif %}" method="post" enctype="multipart/form-data">

        <!-- Target filter -->
        <div class="mb-3">
            <label class="form-label fw-bold">Кому отправить</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="target" id="targetAll" value="all"
                    {% if not mailing or (mailing and mailing.target|default('all') == 'all') %}checked{% endif %}>
                <label class="form-check-label" for="targetAll">Всем клиентам</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="target" id="targetNoRedeem" value="no_redemptions"
                    {% if mailing and mailing.target == 'no_redemptions' %}checked{% endif %}>
                <label class="form-check-label" for="targetNoRedeem">Клиентам без списаний бонусов</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="target" id="targetSelected" value="selected"
                    {% if mailing and mailing.target == 'selected' %}checked{% endif %}>
                <label class="form-check-label" for="targetSelected">Выбранным клиентам</label>
            </div>
        </div>

        <!-- Client selector (shown only when "selected") -->
        <div class="mb-3" id="clientSelectorBlock" style="display: none;">
            <label class="form-label">Выберите клиентов</label>
            <input type="text" id="clientSearch" class="form-control mb-2" placeholder="Поиск по имени или username...">
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 8px;">
                {% for client in clients %}
                <div class="form-check client-item">
                    <input class="form-check-input client-checkbox" type="checkbox" name="client_ids"
                        value="{{ client.id }}" id="client_{{ client.id }}"
                        {% if mailing and mailing.target == 'selected' and client.id|string in selected_ids %}checked{% endif %}>
                    <label class="form-check-label" for="client_{{ client.id }}">
                        {{ client.first_name or '' }} {{ client.last_name or '' }}
                        {% if client.username %}<small class="text-muted">@{{ client.username }}</small>{% endif %}
                    </label>
                </div>
                {% endfor %}
            </div>
            <small class="text-muted mt-1 d-block">Выбрано: <span id="selectedCount">0</span></small>
        </div>

        <hr>

        <div class="mb-3">
            <label class="form-label">Текст рассылки *</label>
            <textarea name="text" class="form-control" rows="5" required placeholder="Поддерживается HTML: &lt;b&gt;жирный&lt;/b&gt;, &lt;i&gt;курсив&lt;/i&gt;">{{ mailing.text if mailing else '' }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Фото</label>
            <input type="file" name="photo" class="form-control" accept=".jpg,.jpeg,.png,.gif,.webp">
            {% if mailing and mailing.photo_path %}
            <div class="mt-2">
                <small class="text-muted">Текущее фото:</small><br>
                <img src="{{ B }}/uploads/{{ mailing.photo_path }}" style="max-height: 100px; border-radius: 8px;" alt="">
            </div>
            {% endif %}
        </div>

        <hr>
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="addButton"
                {% if mailing and mailing.button_text %}checked{% endif %}>
            <label class="form-check-label" for="addButton">Добавить кнопку со ссылкой</label>
        </div>

        <div class="row mb-3" id="buttonFields" style="display: none;">
            <div class="col">
                <label class="form-label">Текст кнопки</label>
                <input type="text" name="button_text" class="form-control" placeholder="Перейти на сайт" value="{{ mailing.button_text if mailing and mailing.button_text else '' }}">
            </div>
            <div class="col">
                <label class="form-label">URL кнопки</label>
                <input type="url" name="button_url" class="form-control" placeholder="https://example.com" value="{{ mailing.button_url if mailing and mailing.button_url else '' }}">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg"></i> {% if mailing %}Сохранить{% else %}Создать черновик{% endif %}
        </button>
    </form>
</div>

<script>
(function() {
    var radios = document.querySelectorAll('input[name="target"]');
    var block = document.getElementById('clientSelectorBlock');
    var search = document.getElementById('clientSearch');
    var items = document.querySelectorAll('.client-item');
    var countEl = document.getElementById('selectedCount');

    function toggleBlock() {
        var selected = document.querySelector('input[name="target"]:checked');
        block.style.display = selected && selected.value === 'selected' ? 'block' : 'none';
    }

    function updateCount() {
        countEl.textContent = document.querySelectorAll('.client-checkbox:checked').length;
    }

    radios.forEach(function(r) { r.addEventListener('change', toggleBlock); });
    toggleBlock();

    search.addEventListener('input', function() {
        var q = this.value.toLowerCase();
        items.forEach(function(item) {
            var text = item.textContent.toLowerCase();
            item.style.display = text.includes(q) ? '' : 'none';
        });
    });

    document.querySelectorAll('.client-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateCount);
    });
    updateCount();

    // Button toggle
    var addBtn = document.getElementById('addButton');
    var btnFields = document.getElementById('buttonFields');
    var btnText = btnFields.querySelector('input[name="button_text"]');
    var btnUrl = btnFields.querySelector('input[name="button_url"]');

    function toggleButton() {
        btnFields.style.display = addBtn.checked ? '' : 'none';
        if (!addBtn.checked) {
            btnText.value = '';
            btnUrl.value = '';
        }
    }
    addBtn.addEventListener('change', toggleButton);
    toggleButton();
})();
</script>
{% endblock %}
